@using System.Text.Json
@model List<BiznesSpoter.Web.Models.PlaceResult>

@{
    ViewData["Title"] = "Mapa Wyników";
    var hasData = Model != null && Model.Any();
}

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>@ViewData["Title"]</h1>
        @if (hasData)
        {
            <span class="badge bg-primary fs-5">Znaleziono: @Model.Count</span>
        }
    </div>

    <!-- Pasek informacyjny o parametrach wyszukiwania -->
    <div class="alert alert-light border shadow-sm d-flex align-items-center mb-4" role="alert">
        <div class="me-auto">
            <strong>Kryteria wyszukiwania:</strong> 
            Branża: <span class="text-primary fw-bold">@ViewData["SearchIndustry"]</span>, 
            Lokalizacja: <span class="text-primary fw-bold">@ViewData["SearchLocation"]</span>
        </div>
        <div class="d-flex align-items-center">
            <span class="text-muted me-2 small text-uppercase fw-bold">Promień:</span>
            <span class="badge bg-info text-dark rounded-pill px-3 py-2" style="font-size: 0.9rem;">
                @ViewData["SearchRadius"] km
            </span>
        </div>
    </div>

    <!-- Przycisk powrotu -->
    <a asp-action="Index" class="btn btn-outline-secondary mb-3">Wróć do wyszukiwania</a>

    @if (!hasData)
    {
        <div class="alert alert-warning">
            Nie znaleziono żadnych miejsc dla podanych kryteriów. Spróbuj zmienić lokalizację lub branżę.
        </div>
    }
    else
    {
        <!-- 1. MAPA -->
        <div id="map" style="height:500px; width:100%; border:1px solid #ddd; border-radius: 8px; margin-bottom: 30px;"></div>

        <!-- 2. TABELA WYNIKÓW (Przeniesiona z Search.cshtml) -->
        <h3 class="mb-3">Szczegóły znalezionych miejsc</h3>
        <div class="table-responsive">
            <table class="table table-striped table-hover shadow-sm">
                <thead class="table-dark">
                    <tr>
                        <th>Nazwa</th>
                        <th>Adres</th>
                        <th>Ocena</th>
                        <th>Liczba opinii</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var place in Model)
                    {
                        <tr>
                            <td class="fw-bold">@place.Name</td>
                            <td>@place.FormattedAddress</td>
                            <td>
                                @if (place.Rating.HasValue)
                                {
                                    <span class="badge bg-success">@place.Rating <i class="bi bi-star-fill"></i></span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>@(place.UserRatingsTotal ?? 0)</td>
                            <td>@place.BusinessStatus</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Serializujemy dane, aby JavaScript na pewno otrzymał poprawny format JSON
        const placesData = @Html.Raw(hasData ? JsonSerializer.Serialize(Model) : "[]");
        
        // FIX 1: Używamy JsonSerializer do liczb, aby ZAWSZE była kropka (np. 52.22), a nie przecinek (52,22)
        const centerLat = @Html.Raw(JsonSerializer.Serialize(ViewData["CenterLat"] ?? 52.2297));
        const centerLng = @Html.Raw(JsonSerializer.Serialize(ViewData["CenterLng"] ?? 21.0122));
        const searchRadiusKm = @Html.Raw(JsonSerializer.Serialize(ViewData["SearchRadius"] ?? 1.0));

        function initMap() {
            const centerPoint = { lat: centerLat, lng: centerLng };

            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: centerPoint,
            });

            // 1. RYSOWANIE OKRĘGU WYSZUKIWANIA (Twój zasięg)
            new google.maps.Circle({
                strokeColor: "#0d6efd", 
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: "#0d6efd",
                fillOpacity: 0.15,
                map,
                center: centerPoint,
                radius: searchRadiusKm * 1000, // km -> metry
                clickable: false
            });

            // Marker środka
            new google.maps.Marker({
                position: centerPoint,
                map: map,
                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                title: "Twoja lokalizacja: @ViewData["SearchLocation"]"
            });

            // 2. RYSOWANIE WYNIKÓW
            const infoWindow = new google.maps.InfoWindow();

            placesData.forEach((place) => {
                // Sprawdzamy czy miejsce ma geometrię
                if (!place.geometry || !place.geometry.location) return;

                const marker = new google.maps.Marker({
                    position: place.geometry.location,
                    map: map,
                    title: place.name,
                });

                // Zdarzenie najechania myszką (opcjonalny mały okrąg przy konkurencji)
                const competitorCircle = new google.maps.Circle({
                    strokeColor: "#dc3545", // Czerwony
                    strokeOpacity: 0.8,
                    strokeWeight: 1,
                    fillColor: "#dc3545",
                    fillOpacity: 0.1,
                    map: null, // Domyślnie ukryty
                    center: place.geometry.location,
                    radius: (searchRadiusKm * 1000) * 1.10,
                    clickable: false
                });

                marker.addListener("mouseover", () => {
                   competitorCircle.setMap(map); // Pokaż okrąg
                });
                
                marker.addListener("mouseout", () => {
                   competitorCircle.setMap(null); // Ukryj okrąg
                });

                // Kliknięcie - dymek z informacją
                marker.addListener("click", () => {
                    // FIX 3: Używamy 'formatted_address' zamiast 'vicinity', bo to mamy w modelu C#
                    const address = place.formatted_address || "";
                    
                    infoWindow.setContent(`
                        <div style="padding:10px; min-width: 200px;">
                            <strong style="font-size:1.1em">${place.name}</strong><br>
                            <span class="text-muted" style="font-size:0.9em">${address}</span><br>
                            <div style="margin-top:5px;">
                                Ocena: <strong>${place.rating || "-"}</strong> 
                                <span style="color:#fbc02d">★</span> 
                                <small class="text-muted">(${place.user_ratings_total || 0} opinii)</small>
                            </div>
                        </div>
                    `);
                    infoWindow.open(map, marker);
                });
            });
        }
    </script>
    
    <!-- FIX 2: Pojedyncze cudzysłowy w atrybucie src, aby nie gryzły się z C# -->
    <script async defer src='https://maps.googleapis.com/maps/api/js?key=@ViewData["GoogleMapsApiKey"]&callback=initMap'></script>
}