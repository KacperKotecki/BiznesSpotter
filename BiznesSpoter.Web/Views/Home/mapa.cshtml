@using System.Text.Json
@model BiznesSpoter.Web.Models.SearchMapViewModel

@{
    ViewData["Title"] = "Mapa Wyników i Analiza Nasycenia";

    var hasPlaces = Model.Places != null && Model.Places.Any();
    var hasGusData = Model.GusStats != null;

    var jsonOptions = new JsonSerializerOptions
    {
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
        WriteIndented = false
    };
}

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>@ViewData["Title"]</h1>
        @if (hasPlaces)
        {
            <span class="badge bg-primary fs-5">Znaleziono miejsc: @Model.Places!.Count</span>
        }
    </div>

    <div class="alert alert-light border shadow-sm d-flex align-items-center mb-4" role="alert">
        <div class="me-auto">
            <strong>Kryteria wyszukiwania:</strong>
            Branża: <span class="text-primary fw-bold">@Model.SearchIndustry</span>,
            Lokalizacja: <span class="text-primary fw-bold">@Model.SearchLocation</span>
        </div>
        <div class="d-flex align-items-center">
            <span class="text-muted me-2 small text-uppercase fw-bold">Promień:</span>
            <span class="badge bg-info text-dark rounded-pill px-3 py-2" style="font-size: 0.9rem;">
                @Model.SearchRadius km
            </span>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-5">
            @if (hasGusData)
            {
                <div class="card border-primary h-100 shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <span class="fw-bold"><i class="bi bi-people-fill me-2"></i>Demografia:
                            @Model.GusStats!.CityName</span>
                        <span class="badge bg-white text-primary">@Model.GusStats.Year</span>
                    </div>
                    <div class="card-body py-4">
                        <p class="text-muted small text-uppercase mb-1">Liczba mieszkańców</p>
                        <h2 class="fw-bold text-primary mb-0">
                            @((Model.GusStats.Population.HasValue) ? Model.GusStats.Population.Value.ToString("N0") : "—")
                        </h2>
                    </div>
                </div>
            }
        </div>

        <div class="col-md-7">
            @if (hasGusData)
            {
                <div class="card h-100 shadow-sm border-0"
                    style="border-left: 8px solid @Model.GusStats!.MarketStatusColor !important;">
                    <div class="card-body py-3">
                        <h5 class="fw-bold mb-1">Analiza Powodzenia Biznesu</h5>
                        <p class="text-muted small mb-3">
                            Na 1 firmę przypada ok. <strong>@Model.GusStats.ResidentsPerBusiness.ToString("N0")</strong>
                            mieszkańców.
                        </p>

                        <div class="d-flex align-items-center gap-3">
                            <div class="px-3 py-2 rounded text-white fw-bold shadow-sm"
                                style="background-color: @Model.GusStats.MarketStatusColor">
                                @Model.GusStats.MarketStatusText
                            </div>
                            <div class="small text-muted">
                                Wskaźnik: <strong>@Model.GusStats.CompetitionIndex.ToString("F2")</strong> <br />
                                <small>(placówek / 10k mieszk.)</small>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="mb-3">
        <a asp-action="Index" class="btn btn-outline-secondary">Wróć do wyszukiwania</a>
    </div>

    @if (!hasPlaces)
    {
        <div class="alert alert-warning">
            Nie znaleziono żadnych miejsc dla podanych kryteriów w Google Maps.
        </div>
    }
    else
    {
        <div id="map" style="height:550px; width:100%; border:1px solid #ddd; border-radius: 8px; margin-bottom: 30px;"
            class="shadow-sm">
        </div>

        <h3 class="mb-3">Szczegóły znalezionych miejsc</h3>
        <div class="table-responsive mb-5">
            <table class="table table-striped table-hover shadow-sm border">
                <thead class="table-dark">
                    <tr>
                        <th>Nazwa</th>
                        <th>Adres</th>
                        <th>Ocena</th>
                        <th>Typy</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var place in Model.Places!)
                    {
                        <tr>
                            <td><strong>@place.Name</strong></td>
                            <td>@place.Vicinity</td>
                            <td>
                                @if (place.Rating.HasValue)
                                {
                                    <span class="badge bg-success">@place.Rating <i class="bi bi-star-fill"
                                            style="font-size:0.7em;"></i></span>
                                    <span class="text-muted small">(@place.UserRatingsTotal)</span>
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </td>
                            <td>
                                @if (place.Types != null)
                                {
                                    <small class="text-muted">@string.Join(", ", place.Types.Take(3))</small>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@section Scripts {
    <script>
        const placesData = @Html.Raw(hasPlaces ? JsonSerializer.Serialize(Model.Places, jsonOptions) : "[]");
        const centerLat = @Html.Raw(JsonSerializer.Serialize(Model.CenterLat));
        const centerLng = @Html.Raw(JsonSerializer.Serialize(Model.CenterLng));
        const searchRadiusKm = @Html.Raw(JsonSerializer.Serialize(Model.SearchRadius));

        function initMap() {
            const centerPoint = { lat: centerLat, lng: centerLng };

            const simplifiedStyle = [
                { "featureType": "poi", "elementType": "labels", "stylers": [{ "visibility": "off" }] },
                { "featureType": "transit", "stylers": [{ "visibility": "off" }] },
                { "elementType": "labels.icon", "stylers": [{ "visibility": "off" }] },
                { "featureType": "poi.park", "elementType": "geometry", "stylers": [{ "color": "#c5e1a5" }] },
                { "featureType": "water", "elementType": "geometry", "stylers": [{ "color": "#b3e5fc" }] },
                { "featureType": "road", "elementType": "geometry", "stylers": [{ "color": "#ffffff" }] }
            ];

            const map = new google.maps.Map(document.getElementById("map"), {
                center: centerPoint,
                zoom: 15,
                styles: simplifiedStyle,
                clickableIcons: false,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                zoomControl: true
            });

            // Okrąg zasięgu
            new google.maps.Circle({
                strokeColor: "#0d6efd",
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: "#0d6efd",
                fillOpacity: 0.15,
                map,
                center: centerPoint,
                radius: searchRadiusKm * 1000,
                clickable: false
            });

            // Marker środka
            new google.maps.Marker({
                position: centerPoint,
                map: map,
                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                title: "Twoja lokalizacja"
            });

            const infoWindow = new google.maps.InfoWindow();

            placesData.forEach((place) => {
                if (!place.geometry || !place.geometry.location) return;

                const marker = new google.maps.Marker({
                    position: place.geometry.location,
                    map: map,
                    title: place.name,
                });

                marker.addListener("click", () => {
                    const address = place.formatted_address || place.vicinity || "";
                    infoWindow.setContent(`
                                    <div style="padding:10px; min-width: 200px;">
                                        <strong style="font-size:1.1em">${place.name}</strong><br>
                                        <span class="text-muted" style="font-size:0.9em">${address}</span><br>
                                        <div style="margin-top:5px;">
                                            Ocena: <strong>${place.rating || "-"}</strong> 
                                            <span style="color:#fbc02d">★</span> 
                                            <small class="text-muted">(${place.user_ratings_total || 0})</small>
                                        </div>
                                    </div>
                                `);
                    infoWindow.open(map, marker);
                });
            });
        }
    </script>

    @{
        var apiKey = Model?.GoogleMapsApiKey as string ?? (ViewData["GoogleMapsApiKey"] as string);
    }
    @if (!string.IsNullOrWhiteSpace(apiKey))
    {
        <script async defer src='https://maps.googleapis.com/maps/api/js?key=@apiKey&callback=initMap'></script>
    }
}