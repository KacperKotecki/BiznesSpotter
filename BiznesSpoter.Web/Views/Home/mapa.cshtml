@using System.Text.Json
@model BiznesSpoter.Web.Models.SearchMapViewModel

@{
    ViewData["Title"] = "Mapa Wyników i Analiza Nasycenia";

    var hasPlaces = Model.Places != null && Model.Places.Any();
    var hasGusData = Model.GusStats != null;

    var jsonOptions = new JsonSerializerOptions
    {
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
        WriteIndented = false
    };
}

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>@ViewData["Title"]</h1>
        @if (hasPlaces)
        {
            <span class="badge bg-primary fs-5">Znaleziono miejsc: @Model.Places!.Count</span>
        }
    </div>

    <!-- ZMIANA 1: Kryteria w stylu karty z paskiem -->
    <div class="card border-0 shadow-sm mb-4" style="border-left: 8px solid #0d6efd !important;">
        <div class="card-body py-3 d-flex align-items-center">
            <div class="me-auto">
                <h5 class="fw-bold mb-1">Kryteria wyszukiwania</h5>
                <span class="text-muted">Branża:</span> <span class="fw-bold text-dark">@Model.SearchIndustry</span>,
                <span class="text-muted">Lokalizacja:</span> <span class="fw-bold text-dark">@Model.SearchLocation</span>
            </div>
            <div class="d-flex align-items-center">
                <span class="text-muted me-2 small text-uppercase fw-bold">Promień:</span>
                <span class="badge bg-light text-dark border px-3 py-2" style="font-size: 0.9rem;">
                    @Model.SearchRadius km
                </span>
            </div>
        </div>
    </div>

        <div class="row g-4 mb-4">
        <!-- Lewa kolumna: Demografia -->
        <div class="col-md-6">
            @if (hasGusData)
            {
                <div class="card h-100 shadow-sm border-0" style="border-left: 8px solid #0d6efd !important;">
                    <div class="card-body py-4 d-flex flex-column justify-content-between">
                        <div>
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="fw-bold mb-1 d-flex align-items-center">
                                    <i class="bi bi-people-fill me-2 fs-4 text-primary"></i>
                                    Demografia
                                </h5>
                                <span class="badge bg-light text-secondary border">Rok: @Model.GusStats!.Year</span>
                            </div>
                            <p class="text-muted mb-4 small">Obszar: <strong>@Model.GusStats.CityName</strong></p>
                        </div>

                        <!-- Usunięto bg-light i bg-opacity, teraz jest czyste tło -->
                        <div class="text-center mt-auto">
                            <span class="text-muted text-uppercase fw-bold small ls-1">Populacja miasta</span>
                            <h1 class="display-4 fw-bold text-dark mb-0 mt-1">
                                @((Model.GusStats.Population.HasValue) ? Model.GusStats.Population.Value.ToString("N0") : "—")
                            </h1>
                            <small class="text-muted">mieszkańców ogółem</small>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Prawa kolumna: Analiza Rynku -->
        <div class="col-md-6">
            @if (hasGusData)
            {
                <div class="card h-100 shadow-sm border-0"
                     style="border-left: 8px solid @Model.GusStats!.MarketStatusColor !important;">
                    <div class="card-body py-4 d-flex flex-column">
                        
                        <!-- Sekcja górna: Nagłówek i Status -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-1 d-flex align-items-center">
                                <i class="bi bi-graph-up-arrow me-2 fs-4" style="color: @Model.GusStats.MarketStatusColor"></i>
                                Analiza Nasycenia
                            </h5>
                            <p class="mb-0 mt-2 fw-bold fs-5" style="color: @Model.GusStats.MarketStatusColor">
                                @Model.GusStats.MarketStatusText
                            </p>
                        </div>

                        <!-- Sekcja dolna: Dwie duże liczby (50% / 50%) -->
                        <div class="row g-0 mt-auto align-items-center">
                            
                            <!-- Lewa strona: Potencjał -->
                            <div class="col-6 border-end">
                                <div class="text-center px-1">
                                    <span class="text-muted text-uppercase fw-bold small" style="font-size: 0.7rem; letter-spacing: 0.5px;">Potencjalni klienci</span>
                                    <div class="display-6 fw-bold my-2 text-dark">
                                        @Model.GusStats.ResidentsPerBusiness.ToString("N0")
                                    </div>
                                    <small class="text-muted lh-1 d-block" style="font-size: 0.85rem;">osób na 1 punkt</small>
                                </div>
                            </div>

                            <!-- Prawa strona: Indeks -->
                            <div class="col-6">
                                <div class="text-center px-1">
                                    <span class="text-muted text-uppercase fw-bold small" style="font-size: 0.7rem; letter-spacing: 0.5px;">Indeks Konkurencji</span>
                                    <div class="display-6 fw-bold my-2" style="color: @Model.GusStats.MarketStatusColor">
                                        @Model.GusStats.CompetitionIndex.ToString("N2")
                                    </div>
                                    <small class="text-muted lh-1 d-block" style="font-size: 0.85rem;">pkt / 10k mieszk.</small>
                                </div>
                            </div>

                        </div>
                        
                    </div>
                </div>
            }
        </div>
    </div>
    @if (!hasPlaces)
    {
        <div class="alert alert-warning">
            Nie znaleziono żadnych miejsc dla podanych kryteriów w Google Maps.
        </div>
    }
    else
    {
        <div id="map" style="height:550px; width:100%; border:1px solid #ddd; border-radius: 8px; margin-bottom: 30px;"
            class="shadow-sm">
        </div>

        <h3 class="mb-3">Szczegóły znalezionych miejsc</h3>
        <div class="table-responsive mb-5">
            <table class="table table-striped table-hover shadow-sm border">
                <thead class="bg-primary text-white">
                    <tr>
                        <th>Nazwa</th>
                        <th>Adres</th>
                        <th>Ocena</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var place in Model.Places!)
                    {
                        <tr>
                            <td><strong>@place.Name</strong></td>
                            <td>@place.Vicinity</td>
                            <td>
                                @if (place.Rating.HasValue)
                                {
                                    <span class="badge bg-success">@place.Rating <i class="bi bi-star-fill"
                                            style="font-size:0.7em;"></i></span>
                                    <span class="text-muted small">(@place.UserRatingsTotal)</span>
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@section Scripts {
    <script>
        const placesData = @Html.Raw(hasPlaces ? JsonSerializer.Serialize(Model.Places, jsonOptions) : "[]");
        const centerLat = @Html.Raw(JsonSerializer.Serialize(Model.CenterLat));
        const centerLng = @Html.Raw(JsonSerializer.Serialize(Model.CenterLng));
        const searchRadiusKm = @Html.Raw(JsonSerializer.Serialize(Model.SearchRadius));
        
        function initMap() {
            const centerPoint = { lat: centerLat, lng: centerLng };

            const simplifiedStyle = [
                { "featureType": "poi", "elementType": "labels", "stylers": [{ "visibility": "off" }] },
                { "featureType": "transit", "stylers": [{ "visibility": "off" }] },
                { "elementType": "labels.icon", "stylers": [{ "visibility": "off" }] },
                { "featureType": "poi.park", "elementType": "geometry", "stylers": [{ "color": "#c5e1a5" }] },
                { "featureType": "water", "elementType": "geometry", "stylers": [{ "color": "#b3e5fc" }] },
                { "featureType": "road", "elementType": "geometry", "stylers": [{ "color": "#ffffff" }] }
            ];

            const map = new google.maps.Map(document.getElementById("map"), {
                center: centerPoint,
                zoom: 15,
                styles: simplifiedStyle,
                clickableIcons: false,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                zoomControl: true
            });

            // Okrąg zasięgu
            new google.maps.Circle({
                strokeColor: "#0d6efd",
                strokeColor: "#2196F3",
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: "#0d6efd",
                fillColor: "#2196F3",
                fillOpacity: 0.15,
                map,
                center: centerPoint,
                radius: searchRadiusKm * 1000,
                clickable: false
            });

            // Marker środka
            new google.maps.Marker({
                position: centerPoint,
                map: map,
                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                title: "Twoja lokalizacja"
            });

            const infoWindow = new google.maps.InfoWindow();

            placesData.forEach((place) => {
                if (!place.geometry || !place.geometry.location) return;

                const marker = new google.maps.Marker({
                    position: place.geometry.location,
                    map: map,
                    title: place.name,
                });

                const competitorCircle = new google.maps.Circle({
                    strokeWeight: 0,        // ZMIANA: 0 oznacza brak krawędzi
                    fillColor: "#FF0000",   // ZMIANA: Czysta, intensywna czerwień
                    fillOpacity: 0.10,      // ZMIANA: Lekko zwiększona widoczność wypełnienia
                    map: map,               
                    center: place.geometry.location,
                    radius: 300,           
                    clickable: false
                });

                marker.addListener("click", () => {
                    const address = place.formatted_address || place.vicinity || "";
                    infoWindow.setContent(`
                            <div style="padding:10px; min-width: 200px;">
                                <strong style="font-size:1.1em">${place.name}</strong><br>
                                <span class="text-muted" style="font-size:0.9em">${address}</span><br>
                                <div style="margin-top:5px;">
                                    Ocena: <strong>${place.rating || "-"}</strong> 
                                    <span style="color:#fbc02d">★</span> 
                                    <small class="text-muted">(${place.user_ratings_total || 0})</small>
                                </div>
                            </div>
                        `);
                    infoWindow.open(map, marker);
                });
            });
        }
        
    </script>

    @{
        var apiKey = Model?.GoogleMapsApiKey as string ?? (ViewData["GoogleMapsApiKey"] as string);
    }
    @if (!string.IsNullOrWhiteSpace(apiKey))
    {
        <script async defer src='https://maps.googleapis.com/maps/api/js?key=@apiKey&callback=initMap'></script>
    }
}